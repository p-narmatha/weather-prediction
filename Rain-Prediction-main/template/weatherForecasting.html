<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Acme&family=Prata&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/2/2.1.0/iconify.min.js"></script>
    <link rel="stylesheet" href={{url_for('static',filename='style.css')}}>
    <title>Weather Forcast</title>
</head>
<body>
    <main class="container pageCard" style="background-color:#17252A">

            <header class="row" style="background-color:powderblue;">
                <h1>Current Weather Forecast</h1>
            </header>

            <section class="row">
                    <div class="col-lg-4"></div>
                    <div class="col-lg-4 searchCard">
                        <h2>Enter City Name</h2>
                        <input id="searchFld" class="search" type="text" onfocus="this.value=''" value="Enter city name here"><br>
                        <button id="searchBut">Search</button>
                        <h5>Recent Searches:</h5>
                        <div id="searchHistory"></div>
                    </div>
                    <div class="col-lg-4"></div>
            </section>
        <div id="map"></div>
	<script>
	function initMap() {
         var geocoder = new google.maps.Geocoder();
  var address = document.getElementById('textboxid').value;

  geocoder.geocode({
    'address': address
  }, function(results, status) {

    if (status == google.maps.GeocoderStatus.OK) {
      var latitude = results[0].geometry.location.lat();
      var longitude = results[0].geometry.location.lng();
    }
  });
		var uluru = {lat: latitude, lng: longitude};
		var map = new google.maps.Map(document.getElementById('map'), {
		zoom: 14,
		center: uluru
		});
		var marker = new google.maps.Marker({
		position: uluru,
		map: map
		});
	}
	</script>
	<script async defer
	src=
"https://maps.googleapis.com/maps/api/js?key=AIzaSyDgW_DttJkiyNwD4BPKCeWJ1ipv8-5K9S4&callback=initMap">
	</script>
            <section id="content" class="hidden">
                    <section class="row">
                        <div class="col-lg-3"></div>
                        <div class="col-lg-6 currentCard">
                            <h4 id="todayCity"></h4>
                            <h5 id="todayDate"></h5>
                            <h5>Current Weather:</h5>
                            <img id="todayIcon"><br>
                            <h6>Temp: </h6><h6 id="todayTemp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="todayWind"></h6><br><br>
                            <h6>Humidity: <h6 id="todayHum"></h6>%</h6><br><br>
                            <h6>UV Index: </h6><div id="uvcolor" class="uvcard"><h6 id="uv"></h6></div><br><br>
                        </div>
                        <div class="col-lg-3"></div>
                    </section>
                    <section><h2>5 Day Forecast</h2></section>
                    <section class="row">
                        <div class="col-lg-1"></div>
                        <div class="col-lg-2 forecastCard">
                            <h5 id="day1"></h5>
                            <img id="day1Icon"><br>
                            <h6>Temp: </h6><h6 id="day1Temp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="day1Wind"></h6><br><br>
                            <h6>Humidity: <h6 id="day1Hum"></h6>%</h6><br><br>
                        </div>
                        <div class="col-lg-2 forecastCard">
                            <h5 id="day2"></h5>
                            <img id="day2Icon"><br>
                            <h6>Temp: </h6><h6 id="day2Temp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="day2Wind"></h6><br><br>
                            <h6>Humidity: <h6 id="day2Hum"></h6>%</h6><br><br>
                        </div>
                        <div class="col-lg-2 forecastCard">
                            <h5 id="day3"></h5>
                            <img id="day3Icon"><br>
                            <h6>Temp: </h6><h6 id="day3Temp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="day3Wind"></h6><br><br>
                            <h6>Humidity: <h6 id="day3Hum"></h6>%</h6><br><br>
                        </div>
                        <div class="col-lg-2 forecastCard">
                            <h5 id="day4"></h5>
                            <img id="day4Icon"><br>
                            <h6>Temp: </h6><h6 id="day4Temp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="day4Wind"></h6><br><br>
                            <h6>Humidity: <h6 id="day4Hum"></h6>%</h6><br><br>
                        </div>
                        <div class="col-lg-2 forecastCard">
                            <h5 id="day5"></h5>
                            <img id="day5Icon"><br>
                            <h6>Temp: </h6><h6 id="day5Temp"></h6><br><br>
                            <h6>Wind: </h6><h6 id="day5Wind"></h6><br><br>
                            <h6>Humidity: <h6 id="day5Hum"></h6>%</h6><br><br>
                        </div>
                        <div class="col-lg-1"></div>
                    </section>
            </section>

    </main>

<!--Script Includes-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.4/dayjs.min.js" integrity="sha512-0fcCRl828lBlrSCa8QJY51mtNqTcHxabaXVLPgw/jPA5Nutujh6CbTdDgRzl9aSPYW/uuE7c4SffFUQFBAy6lg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.4/plugin/utc.min.js" integrity="sha512-m00bfmYnAl3plEBlQfeQUhw/U2uvmw29V2+jxSWpAjankMWS+zAsjezbKWDEJNXqWq9o9qQZSOiA2RKDpa4D5w==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.4/plugin/timezone.min.js" integrity="sha512-pslqxxHAYPCxaSeFSmXXxDkLejD5dbFVC66aiVq0z4v7VTJBU+wqcG1OpNh4p3MjS2D6NCwz/H2QmSc7dXxryg==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script >

dayjs.extend(window.dayjs_plugin_utc);
dayjs.extend(window.dayjs_plugin_timezone);

/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                              Section for assigning global variables                                 //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



let submitEl = document.getElementById("searchBut");
let searchEl = document.getElementById("searchFld");
var searchHistoryButts = document.querySelector("#searchHistory");

var searchHistory = [];
var apiUrl = "https://api.openweathermap.org";
var apiKey = "cd073be3c6ec6dfb60252e0b010da2e8";



/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                 Rendering weather info to the page                                  //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



// Fills out information into the primary current day card
function drawTodayCard (city, weather, time) {
    let date = dayjs().tz(time).format("M/D/YYYY");
    let curDate = document.getElementById("todayDate");
    let todayIcon = document.getElementById("todayIcon");
    let todayTemp = document.getElementById("todayTemp");
    let todayWind = document.getElementById("todayWind");
    let todayHum = document.getElementById("todayHum");
    let uv = document.getElementById("uv");
    let uvcolor = document.getElementById("uvcolor");
    let weatherIcon = `https://openweathermap.org/img/w/${weather.weather[0].icon}.png`;
    todayCity.textContent = city;
    curDate.textContent = date;
    todayIcon.setAttribute("src", weatherIcon);
    todayTemp.textContent = weather.temp;
    todayWind.textContent = weather.wind_speed;
    todayHum.textContent = weather.humidity;
    uv.textContent = weather.uvi;

    if (weather.uvi < 3){
      uvcolor.setAttribute("class", "uvcard green");
    } else if (weather.uvi < 6){
      uvcolor.setAttribute("class", "uvcard yellow");
    } else if (weather.uvi < 8){
      uvcolor.setAttribute("class", "uvcard orange");
    } else{
    uvcolor.setAttribute("class", "uvcard red");
    };

    //console.log(city);
    //console.log(date);
    //console.log(weather.temp);
    //console.log(weather.wind_speed);
    //console.log(weather.humidity);
    //console.log(weather.uvi);
};


// Fills information into the 5 day forcast cards
function drawFiveDay(daily, time) {
    const day1 = dayjs().tz(time).add(1, "day").startOf("day").unix();
    const day5 = dayjs().tz(time).add(6, "day").startOf("day").unix();

    //console.log(daily);

    for (var i = 0; i < daily.length; i++) {
        if (daily[i].dt >= day1 && daily[i].dt < day5) {
            var tStamp = daily[i].dt;
            let day = dayjs.unix(tStamp).tz(time).format("MMM D");
            let date = document.getElementById(`day${i}`);
            let dayIcon = document.getElementById(`day${i}Icon`);
            let dayTemp = document.getElementById(`day${i}Temp`);
            let dayWind = document.getElementById(`day${i}Wind`);
            let dayHum = document.getElementById(`day${i}Hum`);

            let weatherIcon = `https://openweathermap.org/img/w/${daily[i].weather[0].icon}.png`;

            date.textContent = day;
            dayIcon.setAttribute("src", weatherIcon);
            dayTemp.textContent = daily[i].temp.max;
            dayWind.textContent = daily[i].wind_speed;
            dayHum.textContent = daily[i].humidity;

        };
    };
};



/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                  Section for making API calls                                       //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



// function to use the latitude collected from searching via city name in the getLatLong function and make the api call using those values
function getCityInfo(cityData) {
    //console.log(cityData);
    var lat = cityData.lat;
    var lon = cityData.lon;
    var city = cityData.name;

    var url = `${apiUrl}/data/2.5/onecall?lat=${lat}&lon=${lon}&units=imperial&exclude=minutely,hourly&appid=${apiKey}`;

    fetch(url)
        .then(function (res) {
          return res.json();
        })
        .then(function (data) {
          drawTodayCard(city, data.current, data.timezone);
          drawFiveDay(data.daily, data.timezone);
        })
        .catch(function (err) {
          console.error(err);
        });
    // console.log(url);
};


// function that makes an api call using the city name the user seraches for and passes along latitude and
// longitude in order to make the api call for the weather
function getLatLon(search) {
    var url = apiUrl + "/geo/1.0/direct?q="+ search + "&limit=5&appid=" + apiKey;
        fetch(url)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (!data[0]) {
                  alert("Location not found");
                } else {
                  addHistory(search)
                  getCityInfo(data[0]);
                  return;
                }
            })
            .catch(function (err) {
                console.log("error: " + err);
            });
            //console.log(url);
            const content = document.getElementById("content");
            content.removeAttribute("class", "hidden");
};



/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                       Section for fuctions that initiate the functionality                          //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



// Function starts when search button is clicked. takes value from the search field and
//passes it along to both the function to get lat and long, and also to the functions for saving it to search history
function citySearch(e){

    if (!searchEl.value) {
        return;
    };
    e.preventDefault();
    var search = searchEl.value.trim();
    getLatLon(search);
    searchEl.value = "enter city name...";


};

// function to begin the search for lat and lon values using search history buttons instead of the input field
function useSearchHistory(e) {
  if (!e.target.matches("button.history")) {
    return;
  };
  var btn = e.target;
  var search = btn.getAttribute("data-search");
  getLatLon(search);
};



/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                       Section for fuctions that initiate the functionality                          //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



// function to add the recent search to the search history and then redraw the buttons to the page
function addHistory(search) {
    searchHistory.push(search);
    localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
    console.log(searchHistory);
    // call to redraw buttons to page after adding new search to search history
    historyButtons();
};


// function to draw search history buttons to the page
function historyButtons() {
    let historySec = document.getElementById("searchHistory");
    historySec.innerHTML = "";
    //
    for (var i = searchHistory.length - 1; i >= searchHistory.length - 5; i--) {
        if (i < 0){
          return;
        };

        var btn = document.createElement("button");
        btn.setAttribute("type", "button");
        btn.setAttribute("class", "history");
        var space = document.createElement("br");
        btn.setAttribute("data-search", searchHistory[i]);
        // console.log(searchHistory[i]);
        btn.textContent = searchHistory[i];
        historySec.append(btn);
        historySec.append(space);

    };
};


// function to pull the list of previous searches from loacal storage and then have buttons for them created on the page
function createHistory() {
    var savedHistory = localStorage.getItem("searchHistory");
    console.log(savedHistory);
    if (savedHistory) {
        searchHistory = JSON.parse(savedHistory);
    };
    // call to generate search history buttons
    historyButtons();
};



/////////////////////////////////////////////////////////////////////////////////////////////////////////
//                 Section for initial calls to set up page and await user input                       //
/////////////////////////////////////////////////////////////////////////////////////////////////////////



createHistory();
submitEl.onclick = citySearch;
searchHistoryButts.addEventListener("click", useSearchHistory);
</script>
</body>
</html>